{
  "hash": "2efc823e0c338e1d4b83c5a207ebc1f9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Visualizações\"\n---\n\n# Introdução\n\nEste capítulo apresenta visualizações dos principais resultados do modelo econômico.\n\n---\n\n# Preparação\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(scales)\n\noptions(scipen = 999, digits = 2, OutDec = \",\")\n\n# Tema personalizado para os gráficos\ntema_graficos <- theme_minimal(base_size = 12) +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14),\n    plot.subtitle = element_text(color = \"gray40\"),\n    axis.title = element_text(face = \"bold\"),\n    legend.position = \"bottom\",\n    panel.grid.minor = element_blank()\n  )\n\n# Paleta de cores\ncores <- c(\n  \"azul\" = \"#2171B5\",\n  \"verde\" = \"#238B45\",\n  \"laranja\" = \"#D94801\",\n  \"roxo\" = \"#6A51A3\",\n  \"cinza\" = \"#636363\"\n)\n\n# Formatadores\nformatar_numero <- function(x, decimais = 0) {\n  format(round(x, decimais), big.mark = \".\", decimal.mark = \",\", nsmall = decimais)\n}\n\nformatar_moeda <- function(x) {\n  paste0(\"R$ \", formatar_numero(x))\n}\n\nformatar_milhoes <- function(x) {\n  paste0(\"R$ \", round(x / 1000000, 1), \" mi\")\n}\n```\n:::\n\n\n---\n\n# Parâmetros e Funções\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunicipio <- list(n_equipes = 100)\n\ncustos_pessoal <- list(\n  salario_base_medico = 16000,\n  encargos_trabalhistas_pct = 0.70,\n  bolsa_mec = 4106.90,\n  complemento_ms = 4000.00\n)\n\ncustos_pessoal$custo_medico_total <- custos_pessoal$salario_base_medico * \n                                      (1 + custos_pessoal$encargos_trabalhistas_pct)\ncustos_pessoal$custo_preceptor_total <- custos_pessoal$custo_medico_total + \n                                         custos_pessoal$salario_base_medico * 0.10 * 1.70\ncustos_pessoal$bolsa_total_mec_ms <- custos_pessoal$bolsa_mec + custos_pessoal$complemento_ms\n\nprograma <- list(\n  custo_operacional_anual = 50000,\n  incentivo_equipe_residente = 4500\n)\n\neconomico <- list(\n  taxa_desconto = 0.05,\n  horizonte_anos = 10,\n  fator_correcao_aih = 1.5\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconverter_para_baseline <- function(valor_observado, rr, \n                                     prop_mfc = 0.336, prop_gen = 0.664,\n                                     pop_estudo = 600000, pop_alvo = 500000) {\n  denominador <- (prop_mfc * rr) + prop_gen\n  taxa_baseline_600k <- valor_observado / denominador\n  taxa_baseline_500k <- taxa_baseline_600k * (pop_alvo / pop_estudo)\n  return(taxa_baseline_500k)\n}\n\ncalcular_economia_100pct <- function(fator_aih = 1.5) {\n  custo_consulta <- 50.00\n  \n  enc_amb <- data.frame(\n    rr = c(0.40, 0.50, 0.45, 0.49, 0.54, 0.74, 0.57, 0.54,\n           0.63, 0.42, 0.38, 0.35, 0.47, 1.17, 1.68, 1.09,\n           0.71, 0.52, 0.86, 0.66),\n    obs = c(2008, 1835, 897, 4144, 903, 290, 1762, 480,\n            603, 1021, 867, 1030, 830, 2390, 1173, 8713,\n            2269, 4934, 738, 991)\n  )\n  enc_amb$baseline <- mapply(converter_para_baseline, enc_amb$obs, enc_amb$rr)\n  enc_amb$economia <- enc_amb$baseline * (1 - enc_amb$rr) * custo_consulta\n  \n  enc_cir <- data.frame(\n    rr = c(1.21, 0.87, 1.22, 0.91, 1.19, 0.87),\n    obs = c(4458, 989, 147, 1968, 859, 359)\n  )\n  enc_cir$baseline <- mapply(converter_para_baseline, enc_cir$obs, enc_cir$rr)\n  enc_cir$economia <- enc_cir$baseline * (1 - enc_cir$rr) * custo_consulta\n  \n  diag <- data.frame(\n    rr = c(0.66, 0.96, 0.76, 0.49, 0.72, 0.98),\n    obs = c(1201, 385, 510, 1090, 431, 2424),\n    custo = c(39.94, 13.20, 86.00, 48.16, 30.00, 45.00)\n  )\n  diag$baseline <- mapply(converter_para_baseline, diag$obs, diag$rr)\n  diag$economia <- diag$baseline * (1 - diag$rr) * diag$custo\n  \n  lab <- data.frame(\n    rr = c(0.53, 0.85, 0.29, 0.42, 0.73, 0.46, 0.64, 0.81, 0.94, 0.41, 0.82,\n           0.23, 0.71, 0.08, 0.13, 0.56, 0.78, 0.48, 0.47, 0.69, 0.64, 0.74,\n           0.09, 0.67, 0.44, 0.56, 0.60, 0.48, 0.47, 0.36),\n    obs = c(51757, 43746, 22577, 10517, 18265, 9072, 25720, 34673, \n            31127, 22163, 33828, 15603, 11679, 791, 886, 5432, \n            2304, 9181, 9363, 3505, 4386, 1957, 604, 41333, \n            1866, 674, 863, 210, 216, 4365),\n    custo = c(4.11, 1.85, 1.85, 1.85, 1.85, 1.85, 7.86, 1.85, 3.51, 3.51, 3.51,\n              1.85, 8.96, 8.71, 8.71, 11.60, 2.01, 2.01, 2.01, 2.01, 3.51, 2.63, \n              1.65, 3.70, 1.85, 10.15, 10.15, 18.55, 18.55, 16.42)\n  )\n  lab$baseline <- mapply(converter_para_baseline, lab$obs, lab$rr)\n  lab$economia <- lab$baseline * (1 - lab$rr) * lab$custo\n  \n  icsap <- data.frame(\n    rr = c(0.83, 0.76, 0.74, 0.62, 0.52, 0.79, 0.35, 0.78, \n           0.45, 0.57, 0.36, 0.82, 1.06, 0.59),\n    obs = c(128, 160, 244, 271, 230, 86, 54, 136, \n            45, 114, 116, 331, 28, 41),\n    custo = c(761.35, 1178.17, 1756.62, 4774.49, 2553.91, 957.47, 853.21, 646.69,\n              527.15, 1969.07, 1969.07, 679.82, 502.60, 612.67)\n  )\n  icsap$baseline <- mapply(converter_para_baseline, icsap$obs, icsap$rr)\n  icsap$economia <- icsap$baseline * (1 - icsap$rr) * icsap$custo * fator_aih\n  \n  total <- sum(enc_amb$economia) + sum(enc_cir$economia) + \n           sum(diag$economia) + sum(lab$economia) + sum(icsap$economia)\n  return(total)\n}\n\ncalcular_retencao <- function(adicional) {\n  0.40 + (0.90 - 0.40) * (adicional / 0.30)\n}\n\nsimular_programa <- function(taxa_retencao = 0.60, adicional_especialidade_pct = 0.10) {\n  \n  anos <- 0:economico$horizonte_anos\n  n_anos <- length(anos)\n  \n  n_preceptores <- c(0, 4, rep(8, 9))\n  n_equipes_escola <- c(0, 8, rep(16, 9))\n  n_residentes <- c(0, 16, rep(32, 9))\n  \n  n_formados_retidos_acum <- numeric(n_anos)\n  for (i in 4:n_anos) {\n    if (i == 4) {\n      n_formados_retidos_acum[i] <- round(16 * taxa_retencao)\n    } else {\n      n_formados_retidos_acum[i] <- n_formados_retidos_acum[i-1] + round(16 * taxa_retencao)\n    }\n  }\n  \n  n_equipes_mfc <- pmin(n_equipes_escola + n_formados_retidos_acum, 100)\n  prop_mfc <- n_equipes_mfc / 100\n  \n  custo_2med <- 2 * custos_pessoal$custo_medico_total * 12\n  custo_1prec_4res <- custos_pessoal$custo_preceptor_total * 12 +\n                       4 * custos_pessoal$bolsa_total_mec_ms * 12 -\n                       2 * programa$incentivo_equipe_residente * 12\n  economia_por_par <- custo_2med - custo_1prec_4res\n  economia_modelo <- (n_equipes_escola / 2) * economia_por_par\n  \n  adicional_mensal <- custos_pessoal$salario_base_medico * adicional_especialidade_pct\n  investimento_fixacao <- n_formados_retidos_acum * adicional_mensal * \n                           (1 + custos_pessoal$encargos_trabalhistas_pct) * 12\n  \n  custo_operacional <- c(0, rep(programa$custo_operacional_anual, 10))\n  \n  economia_pessoal <- economia_modelo - investimento_fixacao - custo_operacional\n  \n  economia_100pct <- calcular_economia_100pct(1.5)\n  beneficio_saude <- economia_100pct * prop_mfc\n  \n  saldo <- economia_pessoal + beneficio_saude\n  \n  fator_vp <- 1 / ((1 + economico$taxa_desconto) ^ anos)\n  saldo_vp <- saldo * fator_vp\n  vpl <- sum(saldo_vp)\n  \n  return(list(\n    vpl = vpl,\n    cobertura_final = prop_mfc[n_anos],\n    formados_final = n_formados_retidos_acum[n_anos],\n    investimento_total = sum(investimento_fixacao),\n    beneficio_saude_total = sum(beneficio_saude),\n    economia_modelo_total = sum(economia_modelo),\n    dados = data.frame(\n      ano = anos,\n      preceptores = n_preceptores,\n      equipes_escola = n_equipes_escola,\n      residentes = n_residentes,\n      formados_acum = n_formados_retidos_acum,\n      equipes_mfc = n_equipes_mfc,\n      prop_mfc = prop_mfc,\n      economia_modelo = economia_modelo,\n      investimento_fixacao = investimento_fixacao,\n      custo_operacional = custo_operacional,\n      economia_pessoal = economia_pessoal,\n      beneficio_saude = beneficio_saude,\n      saldo = saldo,\n      saldo_vp = saldo_vp\n    )\n  ))\n}\n\n# Simulação base\nresultado <- simular_programa(taxa_retencao = 0.60, adicional_especialidade_pct = 0.10)\n```\n:::\n\n\n---\n\n# 1. Evolução da Cobertura MFC\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_cobertura <- resultado$dados\n\nggplot(df_cobertura, aes(x = ano, y = prop_mfc * 100)) +\n  geom_area(fill = cores[\"azul\"], alpha = 0.3) +\n  geom_line(color = cores[\"azul\"], linewidth = 1.2) +\n  geom_point(color = cores[\"azul\"], size = 3) +\n  geom_hline(yintercept = 100, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(breaks = 0:10) +\n  scale_y_continuous(limits = c(0, 100), labels = function(x) paste0(x, \"%\")) +\n  labs(\n    title = \"Evolução da Cobertura por Médicos de Família\",\n    subtitle = \"Cenário gradual com 60% de retenção\",\n    x = \"Ano\",\n    y = \"Cobertura MFC\"\n  ) +\n  annotate(\"text\", x = 10, y = resultado$cobertura_final * 100 + 5, \n           label = paste0(round(resultado$cobertura_final * 100, 0), \"%\"),\n           fontface = \"bold\", color = cores[\"azul\"]) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Evolução da cobertura MFC ao longo de 10 anos](06_visualizacoes_files/figure-html/fig-cobertura-1.png){#fig-cobertura width=2400}\n:::\n:::\n\n\n---\n\n# 2. Composição das Equipes MFC\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_composicao <- data.frame(\n  ano = rep(resultado$dados$ano, 2),\n  tipo = rep(c(\"Equipes-escola\", \"Formados retidos\"), each = 11),\n  valor = c(resultado$dados$equipes_escola, resultado$dados$formados_acum)\n)\n\nggplot(df_composicao, aes(x = ano, y = valor, fill = tipo)) +\n  geom_area(alpha = 0.8) +\n  scale_x_continuous(breaks = 0:10) +\n  scale_y_continuous(limits = c(0, 100)) +\n  scale_fill_manual(values = c(\"Equipes-escola\" = cores[\"azul\"], \n                                \"Formados retidos\" = cores[\"verde\"])) +\n  labs(\n    title = \"Composição das Equipes com Médicos de Família\",\n    subtitle = \"Equipes-escola (residentes) + formados retidos no município\",\n    x = \"Ano\",\n    y = \"Número de equipes\",\n    fill = \"Tipo\"\n  ) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Composição das equipes com cobertura MFC](06_visualizacoes_files/figure-html/fig-composicao-1.png){#fig-composicao width=2400}\n:::\n:::\n\n\n---\n\n# 3. Fluxo de Caixa Anual\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Preparar dados em formato longo para gráfico de área empilhada\ndf_fluxo <- resultado$dados[, c(\"ano\", \"economia_modelo\", \"investimento_fixacao\", \n                                 \"custo_operacional\", \"beneficio_saude\")]\n\n# Renomear para exibição\ndf_fluxo$saldo <- df_fluxo$economia_modelo - df_fluxo$investimento_fixacao - \n                   df_fluxo$custo_operacional + df_fluxo$beneficio_saude\n\n# Gráfico de linhas mostrando cada componente\ndf_linhas <- data.frame(\n  ano = rep(df_fluxo$ano, 4),\n  componente = factor(\n    rep(c(\"Economia do modelo\", \"(-) Investimento em fixação\", \n          \"Economia em saúde\", \"Saldo total\"), each = 11),\n    levels = c(\"Economia do modelo\", \"(-) Investimento em fixação\", \n               \"Economia em saúde\", \"Saldo total\")\n  ),\n  valor = c(\n    df_fluxo$economia_modelo / 1000,\n    -df_fluxo$investimento_fixacao / 1000,\n    df_fluxo$beneficio_saude / 1000,\n    df_fluxo$saldo / 1000\n  )\n)\n\nggplot(df_linhas, aes(x = ano, y = valor, color = componente)) +\n  geom_line(linewidth = 1.2) +\n  geom_point(size = 2.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(breaks = 0:10) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mil\")) +\n  scale_color_manual(values = c(\n    \"Economia do modelo\" = cores[\"azul\"],\n    \"(-) Investimento em fixação\" = cores[\"laranja\"],\n    \"Economia em saúde\" = cores[\"verde\"],\n    \"Saldo total\" = cores[\"roxo\"]\n  )) +\n  labs(\n    title = \"Evolução dos Componentes do Fluxo de Caixa\",\n    subtitle = \"Valores anuais ao longo dos 10 anos\",\n    x = \"Ano\",\n    y = \"Valor (R$ mil)\",\n    color = \"Componente\"\n  ) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Fluxo de caixa anual do programa](06_visualizacoes_files/figure-html/fig-fluxo-1.png){#fig-fluxo width=3000}\n:::\n:::\n\n\n---\n\n# 4. Saldo Acumulado\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_saldo <- resultado$dados\ndf_saldo$saldo_vp_acum <- cumsum(df_saldo$saldo_vp)\n\nggplot(df_saldo, aes(x = ano, y = saldo_vp_acum / 1000000)) +\n  geom_area(fill = cores[\"verde\"], alpha = 0.3) +\n  geom_line(color = cores[\"verde\"], linewidth = 1.2) +\n  geom_point(color = cores[\"verde\"], size = 3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  scale_x_continuous(breaks = 0:10) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  labs(\n    title = \"Saldo Acumulado em Valor Presente\",\n    subtitle = paste0(\"VPL ao final de 10 anos: \", formatar_moeda(resultado$vpl)),\n    x = \"Ano\",\n    y = \"Saldo acumulado (VP)\"\n  ) +\n  annotate(\"text\", x = 10, y = sum(df_saldo$saldo_vp) / 1000000 + 1, \n           label = formatar_milhoes(resultado$vpl),\n           fontface = \"bold\", color = cores[\"verde\"]) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Saldo acumulado em valor presente](06_visualizacoes_files/figure-html/fig-saldo-acumulado-1.png){#fig-saldo-acumulado width=2400}\n:::\n:::\n\n\n---\n\n# 5. Sensibilidade à Taxa de Retenção\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntaxas <- seq(0.30, 1.00, by = 0.05)\ndf_sens_ret <- data.frame(taxa = taxas, vpl = NA, cobertura = NA)\n\nfor (i in seq_along(taxas)) {\n  r <- simular_programa(taxa_retencao = taxas[i])\n  df_sens_ret$vpl[i] <- r$vpl\n  df_sens_ret$cobertura[i] <- r$cobertura_final\n}\n\nggplot(df_sens_ret, aes(x = taxa * 100, y = vpl / 1000000)) +\n  geom_line(color = cores[\"azul\"], linewidth = 1.2) +\n  geom_point(color = cores[\"azul\"], size = 3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", linewidth = 0.8) +\n  geom_vline(xintercept = 60, linetype = \"dotted\", color = \"gray50\") +\n  scale_x_continuous(breaks = seq(30, 100, by = 10), labels = function(x) paste0(x, \"%\")) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  labs(\n    title = \"Sensibilidade do VPL à Taxa de Retenção\",\n    subtitle = \"Linha vermelha: ponto de equilíbrio (VPL = 0)\",\n    x = \"Taxa de retenção\",\n    y = \"VPL\"\n  ) +\n  annotate(\"text\", x = 60, y = max(df_sens_ret$vpl) / 1000000 * 0.9, \n           label = \"Cenário base\\n(60%)\", hjust = -0.1, size = 3.5) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Impacto da taxa de retenção no VPL](06_visualizacoes_files/figure-html/fig-sens-retencao-1.png){#fig-sens-retencao width=2400}\n:::\n:::\n\n\n---\n\n# 6. Sensibilidade ao Investimento em Fixação\n\n\n::: {.cell}\n\n```{.r .cell-code}\nadicionais <- seq(0, 0.30, by = 0.02)\ndf_sens_adic <- data.frame(adicional = adicionais, vpl = NA)\n\nfor (i in seq_along(adicionais)) {\n  taxa_ret <- calcular_retencao(adicionais[i])\n  r <- simular_programa(taxa_retencao = taxa_ret, adicional_especialidade_pct = adicionais[i])\n  df_sens_adic$vpl[i] <- r$vpl\n}\n\nggplot(df_sens_adic, aes(x = adicional * 100, y = vpl / 1000000)) +\n  geom_line(color = cores[\"roxo\"], linewidth = 1.2) +\n  geom_point(color = cores[\"roxo\"], size = 3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", linewidth = 0.8) +\n  scale_x_continuous(breaks = seq(0, 30, by = 5), labels = function(x) paste0(x, \"%\")) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  labs(\n    title = \"Sensibilidade do VPL ao Investimento em Fixação\",\n    subtitle = \"Considerando que maior adicional aumenta a retenção (40% → 90%)\",\n    x = \"Adicional por especialidade\",\n    y = \"VPL\"\n  ) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Impacto do adicional por especialidade no VPL](06_visualizacoes_files/figure-html/fig-sens-adicional-1.png){#fig-sens-adicional width=2400}\n:::\n:::\n\n\n---\n\n# 7. Comparativo de Cenários de Investimento\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncenarios <- data.frame(\n  nome = c(\"Sem investimento\", \"Baixo (10%)\", \"Moderado (20%)\", \"Alto (30%)\"),\n  adicional = c(0, 0.10, 0.20, 0.30),\n  stringsAsFactors = FALSE\n)\n\ncenarios$retencao <- calcular_retencao(cenarios$adicional)\n\nfor (i in 1:nrow(cenarios)) {\n  r <- simular_programa(cenarios$retencao[i], cenarios$adicional[i])\n  cenarios$cobertura[i] <- r$cobertura_final * 100\n  cenarios$vpl[i] <- r$vpl\n  cenarios$investimento[i] <- r$investimento_total\n  cenarios$beneficio[i] <- r$beneficio_saude_total\n}\n\ncenarios$nome <- factor(cenarios$nome, levels = cenarios$nome)\n\n# Gráfico de barras empilhadas\ndf_barras <- data.frame(\n  cenario = rep(cenarios$nome, 2),\n  tipo = rep(c(\"Investimento em fixação\", \"Economia em saúde\"), each = 4),\n  valor = c(-cenarios$investimento / 1000000, cenarios$beneficio / 1000000)\n)\n\nggplot(df_barras, aes(x = cenario, y = valor, fill = tipo)) +\n  geom_col(width = 0.6) +\n  geom_hline(yintercept = 0, color = \"black\", linewidth = 0.5) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  scale_fill_manual(values = c(\n    \"Investimento em fixação\" = cores[\"laranja\"],\n    \"Economia em saúde\" = cores[\"verde\"]\n  )) +\n  labs(\n    title = \"Investimento vs. Economia em Saúde\",\n    subtitle = \"Comparativo por cenário de investimento (valores acumulados em 10 anos)\",\n    x = \"\",\n    y = \"Valor (R$ milhões)\",\n    fill = \"\"\n  ) +\n  tema_graficos +\n  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![Comparativo de cenários de investimento em fixação](06_visualizacoes_files/figure-html/fig-cenarios-1.png){#fig-cenarios width=3000}\n:::\n:::\n\n\n---\n\n# 8. Cobertura vs. VPL por Cenário\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(cenarios, aes(x = cobertura, y = vpl / 1000000)) +\n  geom_point(aes(size = adicional * 100), color = cores[\"azul\"], alpha = 0.7) +\n  geom_text(aes(label = nome), vjust = -1.5, size = 3.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", linewidth = 0.8) +\n  scale_x_continuous(limits = c(50, 105), labels = function(x) paste0(x, \"%\")) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  scale_size_continuous(range = c(4, 12), labels = function(x) paste0(x, \"%\")) +\n  labs(\n    title = \"Cobertura MFC vs. VPL\",\n    subtitle = \"Tamanho do ponto = percentual de adicional por especialidade\",\n    x = \"Cobertura MFC final\",\n    y = \"VPL\",\n    size = \"Adicional\"\n  ) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Relação entre cobertura MFC e VPL nos diferentes cenários](06_visualizacoes_files/figure-html/fig-cobertura-vpl-1.png){#fig-cobertura-vpl width=2400}\n:::\n:::\n\n\n---\n\n# 9. Decomposição do Resultado (10 anos)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultado_base <- simular_programa(taxa_retencao = 0.60, adicional_especialidade_pct = 0.10)\n\ndf_decomp <- data.frame(\n  componente = factor(\n    c(\"Economia do\\nmodelo\", \"Investimento\\nem fixação\", \"Custo\\noperacional\", \"Economia\\nem saúde\", \"VPL\"),\n    levels = c(\"Economia do\\nmodelo\", \"Investimento\\nem fixação\", \"Custo\\noperacional\", \"Economia\\nem saúde\", \"VPL\")\n  ),\n  valor = c(\n    resultado_base$economia_modelo_total,\n    -resultado_base$investimento_total,\n    -sum(resultado_base$dados$custo_operacional),\n    resultado_base$beneficio_saude_total,\n    resultado_base$vpl\n  ),\n  tipo = c(\"Positivo\", \"Negativo\", \"Negativo\", \"Positivo\", \"Resultado\")\n)\n\nggplot(df_decomp, aes(x = componente, y = valor / 1000000, fill = tipo)) +\n  geom_col(width = 0.6) +\n  geom_hline(yintercept = 0, color = \"black\", linewidth = 0.5) +\n  geom_text(aes(label = paste0(\"R$ \", round(valor / 1000000, 1), \" mi\")), \n            vjust = ifelse(df_decomp$valor >= 0, -0.5, 1.5), size = 3.5) +\n  scale_y_continuous(labels = function(x) paste0(\"R$ \", x, \" mi\")) +\n  scale_fill_manual(values = c(\n    \"Positivo\" = cores[\"verde\"],\n    \"Negativo\" = cores[\"laranja\"],\n    \"Resultado\" = cores[\"azul\"]\n  )) +\n  labs(\n    title = \"Decomposição do Resultado Econômico\",\n    subtitle = \"Cenário base: 60% retenção, 10% adicional por especialidade\",\n    x = \"\",\n    y = \"Valor (R$ milhões)\"\n  ) +\n  tema_graficos +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![Decomposição do resultado econômico em 10 anos](06_visualizacoes_files/figure-html/fig-decomposicao-1.png){#fig-decomposicao width=2400}\n:::\n:::\n\n\n---\n\n# 10. Decomposição da Economia em Saúde\n\nEste gráfico mostra de onde vem a economia em saúde: encaminhamentos, exames ou internações.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calcular economia detalhada por categoria\ncalcular_economia_detalhada <- function(fator_aih = 1.5) {\n  custo_consulta <- 50.00\n  \n  # Encaminhamentos ambulatoriais\n\n  enc_amb <- data.frame(\n    rr = c(0.40, 0.50, 0.45, 0.49, 0.54, 0.74, 0.57, 0.54,\n           0.63, 0.42, 0.38, 0.35, 0.47, 1.17, 1.68, 1.09,\n           0.71, 0.52, 0.86, 0.66),\n    obs = c(2008, 1835, 897, 4144, 903, 290, 1762, 480,\n            603, 1021, 867, 1030, 830, 2390, 1173, 8713,\n            2269, 4934, 738, 991)\n  )\n  enc_amb$baseline <- mapply(converter_para_baseline, enc_amb$obs, enc_amb$rr)\n  enc_amb$economia <- enc_amb$baseline * (1 - enc_amb$rr) * custo_consulta\n  economia_enc_amb <- sum(enc_amb$economia)\n  \n  # Encaminhamentos cirúrgicos\n  enc_cir <- data.frame(\n    rr = c(1.21, 0.87, 1.22, 0.91, 1.19, 0.87),\n    obs = c(4458, 989, 147, 1968, 859, 359)\n  )\n  enc_cir$baseline <- mapply(converter_para_baseline, enc_cir$obs, enc_cir$rr)\n  enc_cir$economia <- enc_cir$baseline * (1 - enc_cir$rr) * custo_consulta\n  economia_enc_cir <- sum(enc_cir$economia)\n  \n  # Exames diagnósticos\n  diag <- data.frame(\n    rr = c(0.66, 0.96, 0.76, 0.49, 0.72, 0.98),\n    obs = c(1201, 385, 510, 1090, 431, 2424),\n    custo = c(39.94, 13.20, 86.00, 48.16, 30.00, 45.00)\n  )\n  diag$baseline <- mapply(converter_para_baseline, diag$obs, diag$rr)\n  diag$economia <- diag$baseline * (1 - diag$rr) * diag$custo\n  economia_diag <- sum(diag$economia)\n  \n  # Exames laboratoriais\n  lab <- data.frame(\n    rr = c(0.53, 0.85, 0.29, 0.42, 0.73, 0.46, 0.64, 0.81, 0.94, 0.41, 0.82,\n           0.23, 0.71, 0.08, 0.13, 0.56, 0.78, 0.48, 0.47, 0.69, 0.64, 0.74,\n           0.09, 0.67, 0.44, 0.56, 0.60, 0.48, 0.47, 0.36),\n    obs = c(51757, 43746, 22577, 10517, 18265, 9072, 25720, 34673, \n            31127, 22163, 33828, 15603, 11679, 791, 886, 5432, \n            2304, 9181, 9363, 3505, 4386, 1957, 604, 41333, \n            1866, 674, 863, 210, 216, 4365),\n    custo = c(4.11, 1.85, 1.85, 1.85, 1.85, 1.85, 7.86, 1.85, 3.51, 3.51, 3.51,\n              1.85, 8.96, 8.71, 8.71, 11.60, 2.01, 2.01, 2.01, 2.01, 3.51, 2.63, \n              1.65, 3.70, 1.85, 10.15, 10.15, 18.55, 18.55, 16.42)\n  )\n  lab$baseline <- mapply(converter_para_baseline, lab$obs, lab$rr)\n  lab$economia <- lab$baseline * (1 - lab$rr) * lab$custo\n  economia_lab <- sum(lab$economia)\n  \n  # Internações ICSAP\n  icsap <- data.frame(\n    rr = c(0.83, 0.76, 0.74, 0.62, 0.52, 0.79, 0.35, 0.78, \n           0.45, 0.57, 0.36, 0.82, 1.06, 0.59),\n    obs = c(128, 160, 244, 271, 230, 86, 54, 136, \n            45, 114, 116, 331, 28, 41),\n    custo = c(761.35, 1178.17, 1756.62, 4774.49, 2553.91, 957.47, 853.21, 646.69,\n              527.15, 1969.07, 1969.07, 679.82, 502.60, 612.67)\n  )\n  icsap$baseline <- mapply(converter_para_baseline, icsap$obs, icsap$rr)\n  icsap$economia <- icsap$baseline * (1 - icsap$rr) * icsap$custo * fator_aih\n  economia_icsap <- sum(icsap$economia)\n  \n  return(list(\n    encaminhamentos = economia_enc_amb + economia_enc_cir,\n    exames = economia_diag + economia_lab,\n    internacoes = economia_icsap,\n    total = economia_enc_amb + economia_enc_cir + economia_diag + economia_lab + economia_icsap\n  ))\n}\n\neconomia_detalhada <- calcular_economia_detalhada(1.5)\n\ndf_economia <- data.frame(\n  categoria = factor(\n    c(\"Encaminhamentos\\n(ambulatoriais e cirúrgicos)\", \n      \"Exames\\n(diagnósticos e laboratoriais)\", \n      \"Internações\\n(ICSAP)\"),\n    levels = c(\"Encaminhamentos\\n(ambulatoriais e cirúrgicos)\", \n               \"Exames\\n(diagnósticos e laboratoriais)\", \n               \"Internações\\n(ICSAP)\")\n  ),\n  valor = c(\n    economia_detalhada$encaminhamentos,\n    economia_detalhada$exames,\n    economia_detalhada$internacoes\n  )\n)\n\ndf_economia$percentual <- df_economia$valor / sum(df_economia$valor) * 100\n\nggplot(df_economia, aes(x = categoria, y = valor / 1000)) +\n  geom_col(fill = cores[\"verde\"], width = 0.6) +\n  geom_text(aes(label = paste0(\"R$ \", round(valor / 1000, 0), \" mil\\n(\", \n                                round(percentual, 1), \"%)\")), \n            vjust = -0.3, size = 4, fontface = \"bold\") +\n  scale_y_continuous(\n    labels = function(x) paste0(\"R$ \", x, \" mil\"),\n    expand = expansion(mult = c(0, 0.15))\n  ) +\n  labs(\n    title = \"Decomposição da Economia em Saúde\",\n    subtitle = \"Economia anual com 100% de cobertura MFC (por categoria)\",\n    x = \"\",\n    y = \"Economia anual\"\n  ) +\n  tema_graficos\n```\n\n::: {.cell-output-display}\n![Decomposição da economia em saúde por categoria](06_visualizacoes_files/figure-html/fig-economia-saude-1.png){#fig-economia-saude width=3000}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Tabela resumo\ntab_economia <- data.frame(\n  categoria = c(\"Encaminhamentos (ambulatoriais e cirúrgicos)\",\n                \"Exames (diagnósticos e laboratoriais)\",\n                \"Internações (ICSAP)\",\n                \"TOTAL\"),\n  valor = c(economia_detalhada$encaminhamentos,\n            economia_detalhada$exames,\n            economia_detalhada$internacoes,\n            economia_detalhada$total),\n  percentual = c(\n    economia_detalhada$encaminhamentos / economia_detalhada$total * 100,\n    economia_detalhada$exames / economia_detalhada$total * 100,\n    economia_detalhada$internacoes / economia_detalhada$total * 100,\n    100\n  )\n)\n\ntab_economia$valor_fmt <- formatar_moeda(tab_economia$valor)\ntab_economia$pct_fmt <- paste0(round(tab_economia$percentual, 1), \"%\")\n\nknitr::kable(\n  tab_economia[, c(\"categoria\", \"valor_fmt\", \"pct_fmt\")],\n  col.names = c(\"Categoria\", \"Economia Anual (100% MFC)\", \"Percentual\"),\n  caption = \"Decomposição da economia em saúde por categoria\"\n)\n```\n\n::: {.cell-output-display}\n\n\nTable: Decomposição da economia em saúde por categoria\n\n|Categoria                                    |Economia Anual (100% MFC) |Percentual |\n|:--------------------------------------------|:-------------------------|:----------|\n|Encaminhamentos (ambulatoriais e cirúrgicos) |R$   504.331              |16.6%      |\n|Exames (diagnósticos e laboratoriais)        |R$   615.020              |20.2%      |\n|Internações (ICSAP)                          |R$ 1.919.752              |63.2%      |\n|TOTAL                                        |R$ 3.039.103              |100%       |\n\n\n:::\n:::\n\n\n**Interpretação:** A maior parte da economia vem da redução de internações por condições sensíveis à atenção primária (ICSAP), seguida pela redução de encaminhamentos e exames.\n\n---\n\n# 11. Linha do Tempo do Programa\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_timeline <- data.frame(\n  ano = c(0, 1, 2, 3, 5, 10),\n  evento = c(\n    \"Início\",\n    \"4 preceptores\\n8 equipes-escola\\n16 R1\",\n    \"8 preceptores\\n16 equipes-escola\\n32 residentes\",\n    \"Primeiros\\nformados\",\n    paste0(round(resultado$dados$prop_mfc[6] * 100, 0), \"% cobertura\"),\n    paste0(round(resultado$cobertura_final * 100, 0), \"% cobertura\\n\", resultado$formados_final, \" formados\")\n  ),\n  y = c(1, 1, 1, 1, 1, 1)\n)\n\nggplot(df_timeline, aes(x = ano, y = y)) +\n  geom_hline(yintercept = 1, color = cores[\"azul\"], linewidth = 2) +\n  geom_point(size = 8, color = cores[\"azul\"]) +\n  geom_text(aes(label = evento), vjust = -1.5, size = 3, lineheight = 0.9) +\n  geom_text(aes(label = paste0(\"Ano \", ano)), vjust = 2.5, size = 3.5, fontface = \"bold\") +\n  scale_x_continuous(limits = c(-0.5, 11)) +\n  scale_y_continuous(limits = c(0.5, 2)) +\n  labs(\n    title = \"Linha do Tempo do Programa de Residência\",\n    subtitle = \"Principais marcos ao longo dos 10 anos\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 14, hjust = 0.5),\n    plot.subtitle = element_text(color = \"gray40\", hjust = 0.5)\n  )\n```\n\n::: {.cell-output-display}\n![Marcos do programa ao longo do tempo](06_visualizacoes_files/figure-html/fig-timeline-1.png){#fig-timeline width=3000}\n:::\n:::\n\n\n---\n\n# Resumo Visual\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Indicadores principais para destaque\nind_cobertura <- paste0(round(resultado$cobertura_final * 100, 0), \"%\")\nind_formados <- resultado$formados_final\nind_vpl <- formatar_milhoes(resultado$vpl)\nind_retorno <- round(resultado$beneficio_saude_total / resultado$investimento_total, 1)\n```\n:::\n\n\n**Indicadores-chave do cenário base (60% retenção, 10% adicional):**\n\n| Indicador | Valor |\n|-----------|-------|\n| Cobertura MFC final | 96% |\n| Formados retidos | 80 médicos |\n| VPL (10 anos) | R$ 3,3 mi |\n| Retorno do investimento | R$ 1.3 por R$ 1 investido |\n\n---\n\n# Conclusões\n\nAs visualizações demonstram que:\n\n1. **A cobertura cresce progressivamente:** De 0% para 96% em 10 anos.\n\n2. **O saldo é positivo desde o início:** A economia do modelo de residência já supera os custos.\n\n3. **O programa é robusto:** VPL positivo em todas as taxas de retenção testadas.\n\n4. **O investimento em fixação se paga:** Maior investimento gera maior cobertura e maior economia em saúde.\n\n5. **Todos os cenários são viáveis:** Mesmo o cenário de máximo investimento (30% adicional) apresenta VPL positivo.\n\n6. **A economia em saúde vem principalmente das internações:** A redução de internações por condições sensíveis à atenção primária (ICSAP) representa a maior fonte de economia, seguida por encaminhamentos e exames.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}